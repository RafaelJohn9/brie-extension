name: Greetings

on:
  pull_request_target:
    types: [opened]
  issues:
    types: [opened]

jobs:
  greet-user:
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Check for prior PRs
        id: check_contributor
        run: |
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"

          echo "Checking previous PRs by $ACTOR in $REPO..."
          has_contributions=$(gh api "/repos/$REPO/pulls?state=all&per_page=1&creator=$ACTOR" | jq 'length')

          if [ "$has_contributions" -eq 0 ]; then
            echo "first_time=true" >> $GITHUB_OUTPUT
          else
            echo "first_time=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Greet contributor
        run: |
          ACTOR="$GITHUB_ACTOR"
          ISSUE_URL="${{ github.event.issue.url }}"
          PR_URL="${{ github.event.pull_request.url }}"
          IS_FIRST="${{ steps.check_contributor.outputs.first_time }}"

          if [ -n "$ISSUE_URL" ]; then
            if [ "$IS_FIRST" = "true" ]; then
              MESSAGE="Hey @$ACTOR,\nThanks for opening your first issue! üêõ\n\nWe'll take a look soon."
            else
              MESSAGE="Hey @$ACTOR,\nThanks for reporting another issue! üôå"
            fi
            gh api --method POST "$ISSUE_URL/comments" -f body="$MESSAGE"
          elif [ -n "$PR_URL" ]; then
            if [ "$IS_FIRST" = "true" ]; then
              MESSAGE="Hey @$ACTOR,\nThanks for your first pull request! üéâ\n\nWe‚Äôll review it shortly."
            else
              MESSAGE="Hey @$ACTOR,\nThanks for another PR! üöÄ"
            fi
            gh api --method POST "$PR_URL/comments" -f body="$MESSAGE"
          else
            echo "No issue or PR URL found ‚Äî skipping comment."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
